# 准确率可视化说明

## 概述

最新版本添加了训练和测试过程的准确率可视化功能，让你更直观地了解模型性能。

## 训练过程准确率

### 功能特点

1. **自动计算准确率**
   - 每5轮计算一次准确率
   - 训练集准确率（抽样500张）
   - 测试集准确率（全部样本）
   - 最后一轮必定计算

2. **实时显示**
   ```
   正在计算准确率...
   
   ================================================================================
   Epoch [5/150] 完成
     平均Loss: 0.038057
     当前Loss: 0.033322
     学习率: 2.00e-04
     训练准确率: 85.60% (抽样500张)
     测试准确率: 84.25%
     耗时: 45.67秒
     预计剩余: 1小时 52分钟
   ================================================================================
   ```

3. **训练曲线图**
   - **Loss曲线** - 训练损失变化
   - **学习率曲线** - 学习率衰减
   - **准确率曲线** - 训练和测试准确率变化 ⭐
   - **Loss vs Accuracy** - 损失和准确率对比 ⭐

### 准确率曲线示例

训练曲线图包含4张子图：

1. **左上：Loss曲线**
   - 显示训练损失随epoch的变化
   
2. **右上：学习率曲线**
   - 显示学习率衰减过程
   
3. **左下：准确率曲线** ⭐
   - 绿线：训练准确率
   - 紫线：测试准确率
   - Y轴：0-100%
   
4. **右下：Loss vs Accuracy** ⭐
   - 蓝线：Loss（左Y轴）
   - 红线：测试准确率（右Y轴）
   - 直观看到损失降低与准确率提升的关系

### 训练总结

训练结束时会显示完整统计：

```
================================================================================
训练总结
================================================================================
总训练时间: 5小时 35分钟 42秒
训练轮数: 150 / 150
最终Loss: 0.001234
最低Loss: 0.001123 (Epoch 142)
最终学习率: 1.00e-06
最终测试准确率: 96.45%
最高测试准确率: 96.78% (Epoch 138)
最终训练准确率: 97.20%
================================================================================
```

## 测试过程可视化

### 增强功能

1. **进度条显示**
   ```
   测试进度: 100%|█████████████| 1000/1000 [00:15<00:00, 65.2it/s]
     准确率: 96.45%
   ```

2. **详细测试报告**
   ```
   ================================================================================
   测试结果
   ================================================================================
   总样本数: 1000
   正确识别: 964
   错误识别: 36
   准确率: 96.40%
   错误率: 3.60%
   ================================================================================
   
   字符级别统计:
     字符总数: 4000
     字符正确: 3982
     字符准确率: 99.55%
   
   位置错误分析:
     位置 1: 5 个错误 (0.50%)
     位置 2: 8 个错误 (0.80%)
     位置 3: 6 个错误 (0.60%)
     位置 4: 7 个错误 (0.70%)
   
   最常见的字符混淆 (Top 10):
     O->0: 12 次
     0->O: 10 次
     I->1: 5 次
     1->I: 4 次
     ...
   ```

3. **可视化图表** ⭐⭐⭐

测试结束自动生成4张分析图：

#### 图表1：整体识别准确率（饼图）
- 绿色：正确识别
- 橙色：错误识别
- 显示数量和百分比

#### 图表2：各位置错误分布（柱状图）
- 显示4个位置各自的错误次数
- 找出哪个位置最容易出错

#### 图表3：Top 10 字符混淆（横向柱状图）
- 显示最常见的字符识别错误
- 例如：O->0, 0->O, I->1等

#### 图表4：准确率对比（柱状图）
- 整体准确率 vs 字符准确率
- 直观对比两种统计方式

### 保存位置

测试结果图表保存在：
```
training_logs/test_results_<时间戳>.png
```

## 使用方法

### 训练（自动计算准确率）

```bash
# 标准训练（每5轮计算一次准确率）
python captcha_train.py

# 或A100优化版
python captcha_train_a100_optimized.py
```

### 测试（自动生成可视化）

```bash
python captcha_test.py
```

测试完成后：
- 在终端看到详细报告
- 在 `training_logs/` 目录查看可视化图表

## 配置选项

### 调整准确率计算频率

编辑 `captcha_train.py`：

```python
# 修改这一行（默认每5轮）
if (epoch + 1) % 5 == 0 or (epoch + 1) == num_epochs:
    # 改为每10轮
if (epoch + 1) % 10 == 0 or (epoch + 1) == num_epochs:
    # 或每轮都计算（会较慢）
if True:
```

### 调整训练集抽样数量

```python
# 默认抽样500张
train_acc = calculate_accuracy(cnn, train_dataloader, device, max_samples=500)

# 改为1000张
train_acc = calculate_accuracy(cnn, train_dataloader, device, max_samples=1000)

# 或全部（会很慢）
train_acc = calculate_accuracy(cnn, train_dataloader, device, max_samples=float('inf'))
```

## 性能影响

| 操作 | 额外耗时 | 建议频率 |
|------|---------|---------|
| 计算训练准确率（500样本） | ~5秒 | 每5-10轮 |
| 计算测试准确率（全部） | ~10-20秒 | 每5-10轮 |
| 绘制训练曲线 | ~1-2秒 | 每10轮 |
| 测试可视化 | ~1秒 | 每次测试 |

**建议配置：**
- ✅ 每5轮计算一次准确率（默认）
- ✅ 每10轮更新训练曲线（默认）
- ✅ 测试时总是生成可视化

## 实际案例

### 训练过程

```
Epoch 5/150: 100%|███████████| 782/782 [02:15<00:00, 5.76it/s]
  Loss: 0.0381, AvgLoss: 0.0452, LR: 0.000200, GPU: 0.23GB

正在计算准确率...

================================================================================
Epoch [5/150] 完成
  平均Loss: 0.045234
  当前Loss: 0.038057
  学习率: 2.00e-04
  训练准确率: 85.60% (抽样500张)
  测试准确率: 84.25%
  耗时: 135.23秒
  预计剩余: 5小时 30分钟
================================================================================

...

Epoch 10/150: 100%|██████████| 782/782 [02:15<00:00, 5.78it/s]

正在计算准确率...

================================================================================
Epoch [10/150] 完成
  平均Loss: 0.028134
  训练准确率: 92.40% (抽样500张)
  测试准确率: 91.35%
================================================================================

✓ 已保存Epoch 10检查点
✓ 训练曲线已更新: training_logs/training_curves_20260202_143020.png
```

### 测试过程

```
================================================================================
模型测试
================================================================================
使用设备: cuda:0
GPU型号: NVIDIA A100-PCIE-40GB
✓ 模型加载完成

测试集样本数: 10000

测试进度: 100%|████████████| 10000/10000 [02:35<00:00, 64.3it/s]
  准确率: 96.45%

================================================================================
测试结果
================================================================================
总样本数: 10000
正确识别: 9645
错误识别: 355
准确率: 96.45%
错误率: 3.55%
================================================================================

字符级别统计:
  字符总数: 40000
  字符正确: 39820
  字符准确率: 99.55%

位置错误分析:
  位置 1: 52 个错误 (0.52%)
  位置 2: 85 个错误 (0.85%)
  位置 3: 68 个错误 (0.68%)
  位置 4: 75 个错误 (0.75%)

最常见的字符混淆 (Top 10):
  O->0: 45 次
  0->O: 38 次
  I->1: 22 次
  1->I: 18 次
  Z->2: 12 次
  2->Z: 10 次
  S->5: 8 次
  5->S: 7 次
  G->6: 6 次
  B->8: 5 次

✓ 测试结果可视化已保存: training_logs/test_results_20260202_150520.png

================================================================================
```

## 优势总结

### 训练阶段

- ✅ 实时了解模型性能
- ✅ 及早发现过拟合/欠拟合
- ✅ 准确率曲线辅助调参
- ✅ Loss和准确率联动分析

### 测试阶段

- ✅ 详细的错误分析
- ✅ 找出容易混淆的字符
- ✅ 位置错误分布分析
- ✅ 多维度可视化图表

## 常见问题

### Q1: 为什么不每轮都计算准确率？

A: 计算准确率需要额外时间（约15-20秒），每轮计算会显著增加训练时间。默认每5轮计算是性能和监控的平衡点。

### Q2: 训练集准确率为什么是抽样的？

A: 完整计算训练集准确率需要很长时间（可能数分钟），抽样500张已经足够代表性，且速度快。

### Q3: 准确率曲线为什么不连续？

A: 因为只在每5轮计算，中间的epoch没有数据，所以曲线是间断的。这是正常的。

### Q4: 如何看到实时准确率？

A: 目前准确率在epoch结束后计算。如需实时准确率，可以在训练循环中添加，但会显著降低训练速度。

### Q5: 测试图表中文显示乱码？

A: 确保安装了支持中文的字体，或修改代码使用英文标签。

## 下一步优化

可能的未来改进：
- [ ] 支持验证集评估
- [ ] 添加混淆矩阵
- [ ] ROC曲线
- [ ] 每个字符的准确率统计
- [ ] 实时准确率流式计算

---

更多问题请查看 [训练可视化说明.md](训练可视化说明.md)
