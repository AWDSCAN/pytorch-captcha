# 验证码生成说明

## 概述

`captcha_gen.py` 支持两种验证码生成方式：

1. **简单风格** - 使用 `captcha` 库生成（原有方式）
2. **复杂风格** - 使用自定义PIL生成器（带干扰线和干扰点）

## 生成模式

### 模式说明

| 模式 | 说明 | 特点 |
|------|------|------|
| `simple` | 仅使用captcha库生成 | 简洁清晰，识别相对容易 |
| `custom` | 仅使用自定义生成器 | 复杂风格，带干扰线和干扰点 |
| `mixed` | 随机混合两种方式 | **推荐**，数据多样性更好 |

### 风格对比

#### Simple模式（captcha库）
- ✅ 风格简洁
- ✅ 生成速度快
- ✅ 字符清晰
- ⚠️ 样式相对单一

#### Custom模式（自定义）
- ✅ 干扰线（5-8条）
- ✅ 干扰点（100-300个）
- ✅ 字符阴影效果
- ✅ 随机位置偏移
- ✅ 随机颜色
- ⚠️ 识别难度更高

#### Mixed模式（推荐）⭐
- ✅ 同时包含两种风格
- ✅ 数据多样性最好
- ✅ 提高模型泛化能力
- ✅ 训练效果更好

## 使用方法

### 方式1：命令行快速生成

```bash
# 直接运行（默认mixed模式，生成100张）
python captcha_gen.py
```

### 方式2：修改参数

编辑 `captcha_gen.py` 的 `if __name__ == '__main__':` 部分：

```python
if __name__ == '__main__':
    # 配置参数
    count = 100           # 修改生成数量
    mode = 'mixed'        # 修改生成模式: 'simple', 'custom', 'mixed'
    path = captcha_setting.TRAIN_DATASET_PATH  # 修改保存路径
```

### 方式3：代码调用

```python
from captcha_gen import gen_captcha_text_and_image

# 混合模式生成
text, image = gen_captcha_text_and_image(mode='mixed')
image.save('test_mixed.png')

# 简单模式生成
text, image = gen_captcha_text_and_image(mode='simple')
image.save('test_simple.png')

# 复杂模式生成
text, image = gen_captcha_text_and_image(mode='custom')
image.save('test_custom.png')
```

## 生成数据集

### 生成训练集

```python
# 修改 captcha_gen.py
count = 100000  # 10万张
path = captcha_setting.TRAIN_DATASET_PATH
mode = 'mixed'  # 推荐使用混合模式
```

```bash
python captcha_gen.py
```

### 生成测试集

```python
# 修改 captcha_gen.py
count = 10000  # 1万张
path = captcha_setting.TEST_DATASET_PATH
mode = 'mixed'
```

```bash
python captcha_gen.py
```

### 生成预测集

```python
# 修改 captcha_gen.py
count = 100  # 100张用于演示
path = captcha_setting.PREDICT_DATASET_PATH
mode = 'mixed'
```

```bash
python captcha_gen.py
```

## 自定义验证码生成器

### CustomCaptchaGenerator 参数

```python
from captcha_gen import CustomCaptchaGenerator

generator = CustomCaptchaGenerator(
    width=160,      # 图片宽度
    height=60,      # 图片高度
    font_size=40    # 字体大小
)

image, text = generator.generate_captcha()
```

### 调整干扰强度

编辑 `captcha_gen.py` 中的 `CustomCaptchaGenerator.generate_captcha()` 方法：

```python
# 调整干扰线数量（当前：5-8条）
line_count = random.randint(5, 8)  # 改为 (3, 5) 可减少干扰

# 调整干扰点数量（当前：100-300个）
dot_count = random.randint(100, 300)  # 改为 (50, 150) 可减少干扰

# 调整干扰线粗细（当前：1-3像素）
width=random.randint(1, 3)  # 改为 1 可使用固定粗细
```

## 配置说明

### 全局配置（captcha_setting.py）

```python
IMAGE_HEIGHT = 60          # 图片高度
IMAGE_WIDTH = 160          # 图片宽度
MAX_CAPTCHA = 4            # 验证码长度（固定4位）
ALL_CHAR_SET = NUMBER + ALPHABET  # 字符集（0-9 + A-Z）
```

### 修改字符集

如果需要修改验证码字符：

```python
# 编辑 captcha_setting.py
NUMBER = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
ALPHABET = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']

# 如果只要数字验证码
ALL_CHAR_SET = NUMBER

# 如果要包含小写字母
lowercase = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z']
ALL_CHAR_SET = NUMBER + ALPHABET + lowercase
```

## 性能和建议

### 生成速度对比

| 模式 | 生成速度 | 1万张耗时 |
|------|---------|----------|
| simple | 快 | ~2分钟 |
| custom | 中等 | ~5分钟 |
| mixed | 中等 | ~3.5分钟 |

### 数据集大小建议

| 用途 | 推荐数量 | 模式 |
|------|---------|------|
| 训练集 | 10万+ | mixed |
| 测试集 | 1万 | mixed |
| 验证集 | 5千 | mixed |
| 演示集 | 100 | mixed |

### 训练建议

#### 为什么推荐mixed模式？

1. **数据多样性**
   - 包含简单和复杂两种风格
   - 提高模型泛化能力
   - 避免过拟合单一风格

2. **实际场景模拟**
   - 真实验证码风格各异
   - 混合训练更接近实际应用
   - 识别准确率更高

3. **训练效果**
   - 简单样本：快速收敛
   - 复杂样本：提升鲁棒性
   - 综合效果最佳

## 示例代码

### 批量生成不同模式

```python
import os
from captcha_gen import gen_captcha_text_and_image
import captcha_setting

# 生成3种模式各1000张
modes = ['simple', 'custom', 'mixed']
for mode in modes:
    output_dir = f'dataset/samples_{mode}'
    os.makedirs(output_dir, exist_ok=True)
    
    print(f"生成 {mode} 模式...")
    for i in range(1000):
        text, image = gen_captcha_text_and_image(mode=mode)
        image.save(f'{output_dir}/{text}_{i}.png')
        if (i + 1) % 100 == 0:
            print(f"  已生成 {i+1}/1000")
```

### 测试生成效果

```python
from captcha_gen import gen_captcha_text_and_image
import matplotlib.pyplot as plt

# 生成3张不同模式的验证码对比
fig, axes = plt.subplots(1, 3, figsize=(15, 5))
modes = ['simple', 'custom', 'mixed']

for i, mode in enumerate(modes):
    text, image = gen_captcha_text_and_image(mode=mode)
    axes[i].imshow(image)
    axes[i].set_title(f'{mode.upper()}: {text}')
    axes[i].axis('off')

plt.tight_layout()
plt.savefig('captcha_comparison.png')
print("对比图已保存到 captcha_comparison.png")
```

## 常见问题

### Q1: 生成的验证码文件名格式是什么？

**格式：** `验证码内容_时间戳.png`

例如：`A1B2_1707123456789012.png` 表示验证码是 "A1B2"

### Q2: 如何只生成数字验证码？

修改 `captcha_setting.py`：
```python
ALL_CHAR_SET = NUMBER  # 只使用数字
```

### Q3: 可以修改验证码长度吗？

可以，但需要同时修改：
1. `captcha_setting.py` 中的 `MAX_CAPTCHA`
2. 重新训练模型（模型输出维度与长度相关）

### Q4: custom模式的干扰会不会太多？

可以通过修改代码调整：
- 减少干扰线数量：`line_count = random.randint(3, 5)`
- 减少干扰点数量：`dot_count = random.randint(50, 150)`
- 去除阴影效果：注释掉阴影绘制代码

### Q5: 生成速度太慢怎么办？

1. **使用simple模式**（最快）
2. **减少干扰**（修改custom模式参数）
3. **多进程生成**：
```python
from multiprocessing import Pool

def generate_batch(args):
    start, end, mode, path = args
    for i in range(start, end):
        text, image = gen_captcha_text_and_image(mode)
        image.save(f'{path}/{text}_{i}.png')

# 使用4个进程并行生成
with Pool(4) as p:
    tasks = [(i*2500, (i+1)*2500, 'mixed', 'dataset/train') for i in range(4)]
    p.map(generate_batch, tasks)
```

## 总结

### 推荐配置

```python
# captcha_gen.py 推荐配置
count = 100000              # 训练集10万张
mode = 'mixed'              # 混合模式
path = captcha_setting.TRAIN_DATASET_PATH
```

### 优势

1. ✅ **两种生成方式** - 灵活选择
2. ✅ **混合模式** - 提高数据多样性
3. ✅ **统一配置** - 使用captcha_setting
4. ✅ **自定义干扰** - 可调整难度
5. ✅ **向后兼容** - 保留原有接口

### 下一步

生成数据集后：
1. 运行 `python captcha_train.py` 或 `python captcha_train_a100_optimized.py` 训练
2. 运行 `python captcha_test.py` 测试准确率
3. 如果准确率不理想，生成更多mixed模式数据

## 参考

- [项目结构说明](项目结构说明.md)
- [快速开始](快速开始.md)
- [OPTIMIZATION_README.md](OPTIMIZATION_README.md)
