# 项目结构说明

## 目录结构

```
pytorch-captcha-recognition/
│
├── 📄 核心代码文件
│   ├── captcha_cnn_model.py          # CNN模型定义（7层卷积网络）
│   ├── captcha_train.py              # 标准训练脚本
│   ├── captcha_train_a100_optimized.py  # A100优化训练脚本
│   ├── captcha_test.py               # 模型测试脚本
│   ├── captcha_predict.py            # 验证码预测脚本
│   ├── captcha_gen.py                # 验证码生成脚本
│   ├── captcha_setting.py            # 全局配置文件
│   ├── my_dataset.py                 # 数据集加载器
│   ├── one_hot_encoding.py           # 编码解码工具
│   └── check_gpu.py                  # GPU环境检测工具
│
├── 📁 dataset/                        # 数据集目录
│   ├── train/                        # 训练集（10w+张图片）
│   ├── test/                         # 测试集
│   └── predict/                      # 预测集
│
├── 📁 docs/                          # 📚 文档目录
│   ├── 版本兼容性说明.md            # Python/PyTorch版本要求
│   ├── OPTIMIZATION_README.md       # 模型优化详细说明
│   ├── GPU支持说明.md               # GPU支持情况说明
│   ├── A100优化指南.md              # A100专属优化指南
│   ├── 优化对比.md                  # 优化前后对比
│   ├── 项目结构说明.md              # 本文件
│   ├── number.png                   # 示例图片1
│   └── number2.png                  # 示例图片2
│
├── 📄 配置文件
│   ├── .gitignore                   # Git忽略规则
│   ├── LICENSE                      # 开源协议
│   └── README.md                    # 项目主说明文档
│
└── 🎯 生成文件（训练时产生）
    ├── model.pkl                    # 训练好的模型
    └── model_epoch_*.pkl            # 训练检查点

```

## 文件详细说明

### 核心代码文件

#### 1. captcha_cnn_model.py
**作用：** 定义CNN模型架构

**内容：**
- 7层卷积网络
- 每层配置：卷积 + BatchNorm + ReLU + (可选)MaxPool
- 输出通道数：32 → 64 → 64 → 128 → 128 → 128 → 128
- 仅全连接层使用Dropout(0.5)

**何时修改：**
- 需要调整网络结构时
- 需要修改层数或通道数时

#### 2. captcha_train.py
**作用：** 标准版训练脚本

**特性：**
- 自动检测GPU
- 余弦学习率衰减
- 150轮训练
- Batch size = 64

**适用场景：**
- 所有NVIDIA GPU
- CPU训练
- 日常训练任务

#### 3. captcha_train_a100_optimized.py
**作用：** A100优化版训练脚本

**特性：**
- TF32加速（Ampere架构）
- 混合精度训练（AMP）
- 多GPU支持
- 显存监控
- Batch size = 128

**适用场景：**
- A100/H100高端GPU
- 需要最快训练速度
- 多卡训练

#### 4. captcha_test.py
**作用：** 模型测试评估

**功能：**
- 加载训练好的模型
- 在测试集上评估准确率
- 显示错误样本
- GPU加速推理

**使用时机：**
- 训练完成后
- 评估模型性能
- 分析错误情况

#### 5. captcha_predict.py
**作用：** 单张或批量验证码识别

**功能：**
- 加载模型
- 预测验证码内容
- GPU加速推理

**使用时机：**
- 实际应用部署
- 验证模型效果
- 批量识别任务

#### 6. captcha_gen.py
**作用：** 生成训练/测试数据

**功能：**
- 使用ImageCaptcha生成验证码图片
- 自动标注（文件名包含答案）
- 可配置数量（1w/5w/10w）

**使用时机：**
- 项目初始化
- 需要更多训练数据
- 测试集不足

#### 7. captcha_setting.py
**作用：** 全局配置

**包含配置：**
```python
IMAGE_HEIGHT = 60         # 图片高度
IMAGE_WIDTH = 160         # 图片宽度
MAX_CAPTCHA = 4           # 验证码字符数
ALL_CHAR_SET_LEN = 36     # 字符集大小（0-9 + A-Z）
TRAIN_DATASET_PATH        # 训练集路径
TEST_DATASET_PATH         # 测试集路径
```

#### 8. my_dataset.py
**作用：** 数据集加载

**功能：**
- 实现PyTorch Dataset
- 图片预处理（灰度化、归一化）
- DataLoader封装

#### 9. one_hot_encoding.py
**作用：** 标签编码/解码

**功能：**
- 将验证码字符串转为one-hot编码
- 将模型输出转回字符串
- 支持多字符预测

#### 10. check_gpu.py
**作用：** GPU环境检测

**功能：**
- 检测GPU型号和数量
- 显示CUDA/cuDNN版本
- 显存使用情况
- 性能测试
- 给出训练建议

## 数据集目录

### dataset/train/
**内容：** 训练集图片

**命名规则：** `验证码内容_时间戳.png`
- 例如：`A1B2_1539937370.png` 表示验证码是 "A1B2"

**建议数量：** 10万张以上

### dataset/test/
**内容：** 测试集图片

**建议数量：** 1万张左右

### dataset/predict/
**内容：** 待预测图片

**用途：** 测试预测功能

## 文档目录 (docs/)

### 版本兼容性说明.md
- Python版本要求（3.10推荐）
- PyTorch版本说明（2.x推荐）
- CUDA版本对应关系
- 安装指南

### OPTIMIZATION_README.md
- 模型结构优化详解
- 7层卷积网络说明
- 训练策略优化
- 使用方法

### GPU支持说明.md
- 支持的GPU型号
- A100是否为N卡说明
- 性能对比
- 常见问题

### A100优化指南.md
- A100特性详解（TF32、AMP）
- 优化效果对比
- 使用建议
- 环境要求

### 优化对比.md
- 优化前后对比表格
- 各项改进点
- 性能数据

## 工作流程

### 1. 初次使用流程

```bash
# 1. 检查环境
python check_gpu.py

# 2. 生成数据集
python captcha_gen.py

# 3. 训练模型（选择一个）
python captcha_train.py                    # 标准版
python captcha_train_a100_optimized.py     # A100优化版

# 4. 测试模型
python captcha_test.py

# 5. 预测验证码
python captcha_predict.py
```

### 2. 文件依赖关系

```
captcha_setting.py  （配置）
    ↓
one_hot_encoding.py  （编码工具）
    ↓
captcha_cnn_model.py  （模型定义）
    ↓
my_dataset.py  （数据加载）
    ↓
captcha_train.py / captcha_train_a100_optimized.py  （训练）
    ↓
model.pkl  （生成模型）
    ↓
captcha_test.py / captcha_predict.py  （测试/预测）
```

### 3. 典型修改场景

#### 场景1：修改验证码字符集
```
修改文件：captcha_setting.py
涉及：ALL_CHAR_SET, ALL_CHAR_SET_LEN
需要：重新生成数据集
```

#### 场景2：修改图片尺寸
```
修改文件：captcha_setting.py
涉及：IMAGE_WIDTH, IMAGE_HEIGHT
需要：重新生成数据集，调整模型
```

#### 场景3：增加网络层数
```
修改文件：captcha_cnn_model.py
涉及：添加新的layer
需要：重新训练
```

#### 场景4：调整训练参数
```
修改文件：captcha_train.py 或 captcha_train_a100_optimized.py
涉及：num_epochs, batch_size, learning_rate
需要：重新训练
```

## 文件大小预估

| 文件/目录 | 典型大小 | 说明 |
|----------|---------|------|
| captcha_cnn_model.py | 3 KB | 代码文件 |
| captcha_train.py | 3 KB | 代码文件 |
| captcha_train_a100_optimized.py | 6 KB | 代码文件 |
| dataset/train/ | ~2-3 GB | 10万张图片 |
| dataset/test/ | ~200 MB | 1万张图片 |
| model.pkl | ~5 MB | 训练好的模型 |
| docs/ | ~1 MB | 文档和示例图 |

## 注意事项

### 1. .gitignore 配置
建议忽略以下内容：
```gitignore
# 模型文件
*.pkl
model*.pkl

# 数据集（太大）
dataset/train/*
dataset/test/*
!dataset/train/.gitkeep
!dataset/test/.gitkeep

# Python
__pycache__/
*.pyc
*.pyo

# IDE
.vscode/
.idea/
*.swp

# 临时文件
*.log
```

### 2. 数据集管理
- 训练集和测试集应该分开生成
- 不要混用训练集和测试集
- 定期备份数据集
- 考虑使用外部存储（数据集较大）

### 3. 模型管理
- 定期保存检查点（每10轮）
- 保留最佳模型
- 记录模型对应的超参数
- 版本控制（model_v1.pkl, model_v2.pkl等）

### 4. 文档维护
- 修改代码时同步更新文档
- 记录重要实验结果
- 保持README.md最新

## 常见问题

### Q: 为什么有两个训练脚本？
A: `captcha_train.py`是标准版，适用于所有设备；`captcha_train_a100_optimized.py`专门优化A100等高端GPU。

### Q: 数据集需要多大？
A: 建议训练集10万张以上，测试集1万张左右。更多数据通常意味着更高准确率。

### Q: 模型文件可以跨平台使用吗？
A: 可以。`.pkl`文件包含模型权重，可以在不同系统间迁移。但需要相同的PyTorch版本和模型结构。

### Q: 如何添加新功能？
A: 
1. 在对应的.py文件中修改
2. 更新相关文档
3. 运行测试确保没有破坏现有功能

## 项目规模

- **代码文件**: 10个（约1500行代码）
- **文档文件**: 6个（详细说明）
- **数据文件**: 10万+张图片
- **模型文件**: 1-5个（不同版本）

## 维护建议

1. **定期更新依赖**: 检查PyTorch新版本
2. **备份数据集**: 避免重新生成
3. **记录实验**: 保存训练日志和结果
4. **代码注释**: 保持代码可读性
5. **文档同步**: 修改后更新文档
